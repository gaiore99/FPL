<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FPL Live — Bonus &amp; DefCon</title>
  <meta name="description" content="Fixtures لايف + BPS→Bonus + DefCon مع إبراز لاعبي فريقك"/>
  
  <!-- خط Google Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#0b0e14;--card:#121621;--border:#1e2433;--ink:#e6e6e6;--muted:#9aa4b2;--accent:#2f7;}
    *{box-sizing:border-box}
    body{font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--ink); margin:0;}
    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,14,20,.95), rgba(11,14,20,.7));backdrop-filter:blur(6px);
           border-bottom:1px solid var(--border); padding:12px 16px; z-index:5;}
    .wrap{max-width:1100px;margin:0 auto;}
    h1{margin:0;font-size:28px;color:var(--accent);font-weight:900;}
    .subtitle{font-size:14px;color:var(--muted);margin-bottom:8px;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    input,button{padding:8px 10px;border:1px solid var(--border);background:#151923;color:var(--ink);border-radius:10px}
    button{cursor:pointer}
    .status{font-size:12px;color:var(--muted)}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(330px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .fixture-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .teams{font-weight:800}
    .kickoff{font-size:12px;color:var(--muted)}
    .pill{font-size:12px;padding:2px 10px;border-radius:999px;border:1px solid var(--border)}
    .pill.live{border-color:var(--accent);}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px dashed #23293b;font-size:14px;vertical-align:middle}
    .bonus{font-weight:800}
    .muted{color:var(--muted)}
    .tag{font-size:11px;border:1px solid #2a3247;border-radius:999px;padding:1px 6px;margin-left:4px}
    .cap{border-color:#ffd54f;color:#ffd54f}
    .vc{border-color:#81d4fa;color:#81d4fa}
    footer{color:var(--muted);font-size:12px;margin:20px 0}
    /* Toasts */
    #toasts{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#0f1320;border:1px solid #2a3247;border-radius:12px;padding:10px 12px;box-shadow:0 6px 30px rgba(0,0,0,.4)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <!-- العنوان الجديد -->
      <h1>FPL CAFE</h1>
      <div class="subtitle">by: gaiore</div>

      <div class="controls">
        <label>الجولة: <input id="gw" type="number" min="1" max="38" value="1"></label>
        <label>Team ID: <input id="teamId" type="number" min="1" value="159748" style="width:120px"></label>
        <button id="applyTeam">Confirm</button>
        <button id="refresh">تحديث الآن</button>
        <span id="status" class="status"></span>
      </div>
    </div>
  </header>
  <main class="wrap">
    <div id="legend" class="muted" style="margin-bottom:10px"></div>
    <div id="fixtures" class="grid"></div>
    <footer>
      <div>
        تقدر تحط ID فريقك فوق و تضغط Confirm
      </div>
    </footer>
  </main>
  <div id="toasts"></div>

  <script>
    let TEAM_ID = Number(localStorage.getItem('TEAM_ID') || 159748);

    const $gw = document.getElementById('gw');
    const $fixtures = document.getElementById('fixtures');
    const $status = document.getElementById('status');
    const $legend = document.getElementById('legend');
    const $teamId = document.getElementById('teamId');
    const $applyTeam = document.getElementById('applyTeam');
    const $toasts = document.getElementById('toasts');

    $teamId.value = TEAM_ID;

    let BOOT;
    let lastDefcon = new Map();

    const sleep = ms => new Promise(r => setTimeout(r, ms));
    function toast(msg){
      const d=document.createElement('div');
      d.className='toast';
      d.textContent=msg;
      $toasts.appendChild(d);
      setTimeout(()=>d.remove(),4000);
    }

    async function j(url){
      const r=await fetch(url);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    function idMap(arr){const m=new Map();for(const x of arr)m.set(x.id,x);return m;}
    function teamShort(BOOT,id){return BOOT.teams.find(t=>t.id===id)?.short_name||'?';}

    function computeBonus(bpsList){
      const sorted=[...bpsList].sort((a,b)=>b.bps-a.bps).slice(0,10);
      if(!sorted.length)return{};
      const byBps={};for(const x of sorted)(byBps[x.bps] ||= []).push(x.element);
      const unique=Object.keys(byBps).map(Number).sort((a,b)=>b-a);
      const awards={};let slots=[3,2,1];
      for(let i=0;i<unique.length && slots.length;i++){
        const pts=slots.shift();
        for(const el of byBps[unique[i]]) awards[el]=(awards[el]||0)+pts;
      }
      return awards;
    }

    function readDefCon(explainEntry){
      if(!Array.isArray(explainEntry))return{value:0,detail:[]};
      const interesting=['defensive_contributions','recoveries','clearances_blocks_interceptions','tackles','blocks','interceptions','clearances','saves'];
      const detail=[];let defVal=0;
      for(const s of explainEntry){
        const id=(s.identifier||'').toLowerCase();
        if(id==='defensive_contributions'||id==='defcon'){defVal=Number(s.points||s.value||0);}
        if(interesting.includes(id)){const val=(s.value!=null?s.value:s.points);detail.push({id,val});}
      }
      return{value:defVal,detail};
    }

    function fmtDetail(detail){
      if(!detail.length)return'لا تفاصيل متاحة';
      return detail.map(d=>`${d.id}: ${d.val}`).join('\\n');
    }

    async function getMyPicks(gw){
      try{return await j(`/api/entry/${TEAM_ID}/event/${gw}/picks`);}
      catch(e){
        try{
          const hist=await j(`/api/entry/${TEAM_ID}/history`);
          const lastFinished=(hist?.current||[]).reverse().find(x=>x.finished===true)||(hist?.current||[])[0];
          if(lastFinished)return await j(`/api/entry/${TEAM_ID}/event/${lastFinished.event}/picks`);
        }catch(_){}
      }
      return null;
    }

    async function render(){
      $status.textContent='جارِ التحديث…';
      try{
        if(!BOOT){BOOT=await j('/api/bootstrap');}
        const elementsById=idMap(BOOT.elements);
        const currentGW=BOOT.events.find(e=>e.is_current)?.id||BOOT.events.find(e=>!e.finished)?.id||1;
        if(!$gw.dataset.init){$gw.value=currentGW;$gw.dataset.init='1';}
        const gw=Number($gw.value);

        const [fixtures,live,picks]=await Promise.all([
          j(`/api/fixtures?event=${gw}`),
          j(`/api/live/${gw}`),
          getMyPicks(gw)
        ]);

        const mySet=new Set();let capEl=null,vcEl=null;
        if(picks?.picks){
          for(const p of picks.picks){
            mySet.add(p.element);
            if(p.is_captain||p.multiplier===2)capEl=p.element;
            if(p.is_vice_captain)vcEl=p.element;
          }
        }
        $legend.innerHTML=`الفريق النشط: <b>${TEAM_ID}</b> — الجولة: <b>${gw}</b> — <span class="tag">فريقي</span> <span class="tag cap">C</span> <span class="tag vc">VC</span>`;

        const explainByElement={};
        if(Array.isArray(live.explain)){
          for(const fx of live.explain){
            for(const player of fx.explain||[]){
              explainByElement[player.element]=player.stats||[];
            }
          }
        }

        const bpsByFixture={};
        if(Array.isArray(live.elements)){
          for(const el of live.elements){
            const elId=el.id;
            const bps=el.stats?.bps??0;
            const fixtureId=el.explain?.[0]?.fixture||null;
            if(!fixtureId)continue;
            (bpsByFixture[fixtureId] ||= []).push({element:elId,bps});
          }
        }

        $fixtures.innerHTML='';
        const fr=document.createDocumentFragment();

        for(const f of fixtures){
          const fxId=f.id;
          const home=teamShort(BOOT,f.team_h);
          const away=teamShort(BOOT,f.team_a);
          const ko=f.kickoff_time?new Date(f.kickoff_time).toLocaleString():'—';

          const bpsList=bpsByFixture[fxId]||[];
          const bonus=computeBonus(bpsList);
          const top=bpsList.sort((a,b)=>b.bps-a.bps).slice(0,8).map(row=>{
            const p=elementsById.get(row.element);
            const name=p?p.web_name:`#${row.element}`;
            const defObj=readDefCon(explainByElement[row.element]);
            const mine=mySet.has(row.element);
            const isC=row.element===capEl;
            const isVC=row.element===vcEl;
            return{id:row.element,name,bps:row.bps,bonus:bonus[row.element]||0,def:defObj,mine,isC,isVC};
          });

          for(const r of top){
            const prev=lastDefcon.get(r.id)||0;
            if(r.def.value>prev){
              toast(`DefCon ↑ للاعب ${r.name}: ${prev} → ${r.def.value}`);
              lastDefcon.set(r.id,r.def.value);
            }
          }

          const rowsHtml=top.map(r=>{
            const tags=[];
            if(r.mine)tags.push('<span class="tag">فريقي</span>');
            if(r.isC)tags.push('<span class="tag cap">C</span>');
            if(r.isVC)tags.push('<span class="tag vc">VC</span>');
            const defTitle=fmtDetail(r.def.detail).replace(/"/g,'\\"');
            const defCell=r.def.value?`<span title="${defTitle}">${r.def.value}</span>`:'<span class="muted" title="لا تفاصيل">—</span>';
            return`<tr><td>${r.name} ${tags.join(' ')}</td><td>${r.bps}</td><td class="bonus">${r.bonus}</td><td>${defCell}</td></tr>`;
          }).join('');

          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <div class="fixture-head">
              <div>
                <div class="teams">${home} vs ${away}</div>
                <div class="kickoff">${ko}</div>
              </div>
              <div class="pill ${f.started?'live':''}">${f.started?'LIVE':'Scheduled'}</div>
            </div>
            <table>
              <thead><tr><th>اللاعب</th><th>BPS</th><th>Bonus</th><th>DefCon</th></tr></thead>
              <tbody>${rowsHtml}</tbody>
            </table>`;
          fr.appendChild(card);
        }
        $fixtures.appendChild(fr);
        $status.textContent='آخر تحديث: '+new Date().toLocaleTimeString();
      }catch(err){
        console.error(err);
        $status.textContent='تعذر الجلب — حاول مجددًا';
      }
    }

    document.getElementById('refresh').addEventListener('click',render);
    $applyTeam.addEventListener('click',()=>{
      const v=Number($teamId.value);
      if(!v)return;
      TEAM_ID=v;
      localStorage.setItem('TEAM_ID',String(v));
      lastDefcon=new Map();
      render();
    });

    render();
    (async function loop(){while(true){await sleep(30000);await render();}})();
  </script>
</body>
</html>
